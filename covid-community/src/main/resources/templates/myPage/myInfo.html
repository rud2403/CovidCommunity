<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>CoCo - 마이페이지</title>

    <!-- Custom fonts for this template -->
    <link href="../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../css/sb-admin-2.min.css" rel="stylesheet">
    
    <!-- 다음 우편주소 api 적용 -->
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <!-- 제이쿼리 적용 -->
	<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- 사이드 바 시작 -->
		<ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

			<!-- Sidebar - Brand -->
			<a class="sidebar-brand d-flex align-items-center justify-content-center" th:href="@{/}">
				<div class="sidebar-brand-text mx-3">Covid Community</div>
			</a>
			
			<!-- Divider -->
			<hr class="sidebar-divider">

			<li class="nav-item">
				<a class="nav-link" th:href="@{/}">
					<i class="fas fa-home"></i>
					<span>홈</span>
				</a>
			</li>

			<!-- Nav Item - Tables -->
			<li class="nav-item">
				<a class="nav-link" th:href="@{/review/list}">
					<i class="fas fa-fw fa-table"></i>
					<span>후기 게시판</span>
				</a>
			</li>

			<li class="nav-item">
				<a class="nav-link" th:href="@{/defStatus}">
					<i class="fas fa-fw fa-chart-area"></i>
					<span>발생현황</span></a>
			</li>
			<li class="nav-item">
				<a class="nav-link" th:href="@{/vaccinationStatus}">
					<i class="fas fa-fw fa-chart-area"></i>
					<span>접종현황</span></a>
			</li>
			<div th:if="${loginDTO}">
				<li class="nav-item active">
					<a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#myPageDetail"
						aria-expanded="true" aria-controls="collapseTwo">
						<i class="fas fa-user"></i>
						<span>마이페이지</span>
					</a>
					<div id="myPageDetail" class="collapse show" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
						<div class="bg-white py-2 collapse-inner rounded">
							<h6 class="collapse-header">계정</h6>
							<a class="collapse-item active" th:href="@{../myPage/myInfo}">내정보 관리</a>
							<h6 class="collapse-header">글 관리</h6>
							<a class="collapse-item" th:href="@{../myPage/myBoardList}">내가 쓴 글</a>
							<a class="collapse-item" th:href="@{../myPage/myComment}">내 댓글</a>
							<a class="collapse-item" th:href="@{../myPage/myLike}">좋아요 누른 글</a>
						</div>
					</div>
				</li>
			</div>
			<div th:if="${loginDTO}">
				<div th:if="${loginDTO.userRole == 'ROLE_ADMIN'}">
					<li class="nav-item">
						<a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#adminPageDetail"
							aria-expanded="true" aria-controls="collapseTwo">
							<i class="fas fa-fw fa-cog"></i>
							<span>관리자페이지</span>
						</a>
						<div id="adminPageDetail" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
							<div class="bg-white py-2 collapse-inner rounded">
								<a class="collapse-item" th:href="@{../admin/userManagement}">유저 관리</a>
								<a class="collapse-item" th:href="@{../admin/boardManagement}">게시글 관리</a>
							</div>
						</div>
					</li>
				</div>
			</div>
		</ul>
		<!-- 사이드 바 끝 -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- 상단 네비바 시작 -->
				<nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

					<ul class="navbar-nav ml-auto">
						<!-- Nav Item - Alerts -->
						<div th:if="${loginDTO}">
							<!-- 회원 닉네임 보이는 구역 시작 -->
							<li class="nav-item dropdown no-arrow">
								<a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
									data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									<div th:if="${loginDTO}">
										<span th:text="${loginDTO.userNickName}" style="color: black;" class="mr-2"></span>
									</div>
								</a>
								<!-- 닉네임 클릭시 드롭다운 -->
								<div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
									aria-labelledby="userDropdown">
									<a class="dropdown-item" th:href="@{/myPage/myInfo}">
										<i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
										마이페이지
									</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item" data-toggle="modal" style="cursor: pointer;" data-target="#logoutModal">
										<i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
										로그아웃
									</a>
								</div>
							</li>
							<!-- 회원 닉네임 보이는 구역 끝 -->
						</div>
						<div th:unless="${loginDTO}">
							<a class="mt-4 mr-3" id="logInTxt" style="cursor: pointer;" th:href="@{/login}">로그인</a>
							<a class="mt-4" id="signUpTxt" style="cursor: pointer;" th:href="@{/register}">회원가입</a>
						</div>
					</ul>
				</nav>
				<!-- 상단 네비바 끝 -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <h1 class="h3 mb-2 text-gray-800">내 정보 관리</h1>

                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-body" style="width: 65%; margin: auto;">
                        
                        	<form>
							  <div class="form-group row">
							    <label for="inputEmail3" class="col-sm-2 col-form-label">이메일</label>
							    <div class="col-sm-10">
							      <input type="email" class="form-control" id="user_email" th:value="${loginDTO.userEmail}" disabled>
							    </div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">비밀번호</label>
							    <div class="col-sm-10">
							      <input type="password" class="form-control" id="user_pw">
							    </div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">비밀번호 확인</label>
							    <div class="col-sm-10">
							      <input type="password" class="form-control" id="user_pwCon">
							    </div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">닉네임</label>
							    <div class="col-sm-10">
							      <input type="text" class="form-control" id="user_nickName" th:value="${loginDTO.userNickName}">
							    </div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">생년월일</label>
							    <div class="row-6" style="text-align: center; margin: auto;">
	                               			<select class="custom-select col-4 ml-3" style="width: 200px" id="selectYear"></select>
	                               			<span class="mr-3">년</span>
	                               			<select class="custom-select col-4" style="width: 150px" id="selectMonth"></select>
	                               			<span class="mr-3">월</span>
	                               			<select class="custom-select col-4" style="width: 150px" id="selectDate"></select>
	                               			<span class="mr-3">일</span>
	                                	</div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">주소</label>
							    <div class="col-sm-10">
							      <input type="text" class="form-control" id="address_kakao">
							    </div>
							  </div>
							  <div class="form-group row">
							    <label for="inputPassword3" class="col-sm-2 col-form-label">상세주소</label>
							    <div class="col-sm-10">
							      <input type="text" class="form-control" id="address_kakao_detail">
							    </div>
							  </div>
							</form>
                        	<div class="form-group row">
							    <div class="col-sm-10 text-center" style="margin: auto;">
							      <button class="btn btn-primary" id="subBtn">수정하기</button>
							    </div>
							  </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- 푸터 시작 -->
			<footer class="sticky-footer bg-white">
				<div class="container my-auto">
					<div class="copyright text-center my-auto">
						<span>Copyright &copy; CovidCommunity 2022</span>
					</div>
				</div>
			</footer>
			<!-- 푸터 끝 -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- 로그아웃 모달 -->
	<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">로그아웃</h5>
					<button class="close" type="button" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="modal-body">정말 로그아웃 하시겠습니까?</div>
				<div class="modal-footer">
					<a class="btn btn-primary" th:href="@{/logout}">확인</a>
					<button class="btn btn-secondary" type="button" data-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		$(document).ready(function(){
			
			let userInfo = "[[${loginDTO}]]";
			let userId = "[[${loginDTO.userId}]]";
			
			// 주소 설정 시작
			let userAddr = "[[${loginDTO.userAddr}]]"
			userAddr = userAddr.split("/"); 
			
			// console.log('userInfo : ', userInfo);
			
			$('#address_kakao').val(userAddr[0]);
			$('#address_kakao_detail').val(userAddr[1]);
			
			// 생년월일 설정 시작
			let userBirth =	"[[${loginDTO.userBirth}]]"
			
			userBirth = userBirth.split("/");
			console.log('userBirth : ', userBirth);
			
			// 생년월일 select 세팅 시작
			let nowDate = new Date();
			let year = nowDate.getFullYear();
			let html = "";
			
			for(let i = year; i > year - 40; i--){
				if(i == userBirth[0]){
					html += "<option value="+i+" selected>"+i+"</option>"
				} else{
					html += "<option value="+i+">"+i+"</option>"
				}
			}
			$("#selectYear").append(html);
			html = "";
			for(let i = 1; i < 13; i++){
				if(i == userBirth[1]){
					html += "<option value="+i+" selected>"+i+"</option>"
				} else{
					html += "<option value="+i+">"+i+"</option>"
				}
			}
			$("#selectMonth").append(html);
			html = "";
			for(let i = 1; i < 32; i++){
				if(i == userBirth[2]){
					html += "<option value="+i+" selected>"+i+"</option>"
				} else{
					html += "<option value="+i+">"+i+"</option>"
				}
			}
			$("#selectDate").append(html);
			html = "";
			// 생년월일 select 세팅 끝
			
			// 다음 주소 api 시작
			$("#address_kakao").click(function(){
				new daum.Postcode({
			        oncomplete: function(data) {
			            $("#address_kakao").val(data.address);
			            $("#address_kakao_detail").val("");
			            $("#address_kakao_detail").focus();
			        }
			    }).open();
			});
			
			$('#subBtn').click(function(){
				
				let userEmail = $("#user_email").val();
				let userPw = $("#user_pw").val();
				let userPwCon = $("#user_pwCon").val();
				let userNickName = $("#user_nickName").val();
				let userBirth = $("#selectYear").val() + "/" + $("#selectMonth").val() + "/" + $("#selectDate").val();
				let addrKaKao = $("#address_kakao").val();
				let addrKaKaoDetail = $("#address_kakao_detail").val();
				let userAddr = addrKaKao + "/" + addrKaKaoDetail;
				
				// 닉네임 유효성 체크
				let specialCheck = /[`~!@#$%^&*|\\\'\";:\/?]/gi;
				
				if(userPw == null || userPw == ""){
					alert('비밀번호를 입력해주세요.');
					$("#user_pw").focus();
					return false;
				}
				if(userPwCon == null || userPwCon == ""){
					alert('비밀번호 확인을 입력해주세요.');
					$("#user_pwCon").focus();
					return false;
				}
				if(userPw != userPwCon){
					alert('비밀번호가 일치하지 않습니다.');
					$("#user_pwCon").focus();
					return false;
				}
				if(userNickName == null || userNickName == ""){
					alert('닉네임을 입력해주세요.');
					$("#user_name").focus();
					return false;
				}
				if(userNickName.search(/\s/) != -1) {
					alert('닉네임에 빈칸을 포함할 수 없습니다.');
					$("#user_nickName").focus();
					return false;
				} else if(specialCheck.test(userNickName)) {
					alert('닉네임에 특수문자를 사용할 수 없습니다.');
					$("#user_nickName").focus();
					return false;
				}
				if(addrKaKao == null || addrKaKao == ""){
					alert('주소를 입력해주세요.');
					$("#address_kakao").focus();
					return false;
				}
				if(addrKaKaoDetail == null || addrKaKaoDetail == ""){
					alert('상세주소를 입력해주세요.');
					$("#address_kakao_detail").focus();
					return false;
				}
				
				let userInfo = {
					userId,
					userEmail,
	           		userPw,
	           		userNickName,
	           		userBirth,
	           		userAddr
				}
				
				console.log('userInfo : ', userInfo);
				
				$.ajax({
		            type : 'PUT',
		            url : "../myPage/api/myInfo",
		            data : JSON.stringify(userInfo),
		            dataType : "json",
		            contentType: "application/json; charset=UTF-8",
		            success : function(data) {
		            	console.log('data : ', data);
		            	if(data == 1){
		            		alert('회원정보가 수정 되었습니다.');
		            		$("#user_pw").val("");
		            		$("#user_pwCon").val("");
		            		
		            	} else if(data == 0){
		            		alert('회원정보 수정 오류');
		            	} else if (data ==2 ){
		            		alert('중복된 닉네임 입니다.');
		            	} else {
		            		alert('회원정보 수정 오류');
		            	}
		            },
		            error : function(error) {
		            	console.log('error : ', error);
		            }
		        });	
				
			});
		});
		// 제이쿼리 끝
	</script>
    <!-- Bootstrap core JavaScript-->
    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../js/sb-admin-2.min.js"></script>

</body>

</html>